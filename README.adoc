= What's Healthcare?
:toc: manual

Healthcare System is mainly for synchronization of master patient records across different healthcare providers. It is important to have consistent patient information across these multiple providers so that patients may receive consistent care. For that to occur, their personal and medical information needs to be shared. Also, any updates to the patient record need to flow across the providers to maintain accuracy and currency.

Primary purpose of this documents is provide a way to deploy Healthcare System both locally and on cloud OpenShift.

== Healthcare System Introduction

Healthcare System is a Fuse(Camel)/AMQ/Apache CXF based project, which mainly contains 3 components:

* *Inbound* - Receive the inbound request via a DEIM Rest Service entrypoint, each request will trigger a camel content, which marshal the request object to xml, then send xml to Queue.
* *Xlate* - Provide a type convert function, which convert the `DEIM REST Service` model to `Nextgate SOAP Service` model, the converted result be sent to Queue
* *Outbound* - Retrive the `Nextgate SOAP Service` model from Queue, invoke the `Nextgate` Service.

image:etc/img/healthcare-arch.png[]

=== Inbound Route

image:etc/img/inbound-route.png[]

1. DEIM REST Service receive the request 
2. DEIM REST Service invoke the Camel Route, forward request to Camel Route
3. JAXB Marshal request Object to XML Format
4. Initialize AMQ Client(AMQP Configuration, JmsConnectionFactory, Producer, etc)
5. Send the XML format request to Queue
6. Format response code base on Queue Sender results
7. Send the response code back to DEIM REST Service
8. DEIM REST Service Recieve Camel route response code
9. Done 

=== Xlate Route

image:etc/img/xlate-route.png[]

10. Consume message from Queue
11. Trigger the JAXB, unmarshal XML to Object
12. Invoke Type Convert Processor, convert the `DEIM REST Service` model to `Nextgate SOAP Service` model
13. JAXB marshal converted result to xml
14. Trigger AMQ Client(AMQP Configuration, JmsConnectionFactory, Producer, etc)
15. Send converted result to Queue

=== Outbound Route

image:etc/img/outbound-route.png[]

16. Consume message from Queue
17. Trigger the JAXB, unmarshal XML to Object
18. Invoke Nextgate Web Service 
19. Send Request to Nextgate Web Service

=== Full Modules

The completed modules including:

[cols="2,5a"]
|===
|*Module Name* |*DESC/NOTES*

|model
|Healthcare XSD Schema based model.

|nextgate-model
|Nextgate SOAP Service XSD Schema based model.

|inbound
|Handle the request, forward the result to Queue, refer to <<Inbound Route, Inbound Route>> for more details.

|xlate
|Type convert module, forward the converted result to Queue, refer to <<Xlate Route, Xlate Route>> for more details.

|outbound
|Invoke Nextgate SOAP Service, refer to <<Outbound Route, Outbound Route>> for more details.

|nextgate
|A simple NextGate SOAP Web Service，which used to keep Patient Records.

|client
|Used for test, a simple JMS Client which used to message to `q.empi.deim.in`, the message is a text message is Marshalled from a `com.customer.app.Person` Object with JAXB.
|===

=== Build

[source, java]
----
$ git clone https://github.com/kylinsoong/healthcare.git
$ cd healthcare/
$ mvn clean package
...
[INFO] healthcare ......................................... SUCCESS [  0.162 s]
[INFO] Healthcare Model ................................... SUCCESS [  3.633 s]
[INFO] Healthcare Nextgate Model .......................... SUCCESS [  0.176 s]
[INFO] Healthcare NextGate SOAP Service ................... SUCCESS [  1.099 s]
[INFO] Healthcare Inbound ................................. SUCCESS [  5.044 s]
[INFO] Healthcare xlate ................................... SUCCESS [  0.757 s]
[INFO] Healthcare outbound ................................ SUCCESS [  0.679 s]
[INFO] Healthcare Client .................................. SUCCESS [  0.115 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
...
----

== Healthcare System Deployment

=== Prerequisites

[source, text]
.*1. Create Imagestream fuse7-java-openshift in OpenShift(link:etc/files/fuse7-java-openshift.json[fuse7-java-openshift.json])*
----
# oc create -f fuse7-java-openshift.json -n openshift
----

[source, text]
.*2. Deploy Nextgate SOAP Service*
----
$ cd nextgate
$ mvn fabric8:deploy -Popenshift
----

Refer to link:nextgate/README.adoc[nextgate/README.adoc] for more details.

=== AMQ

==== Local Deployment

[source, text]
.*1. unzip to install*
----
$ unzip amq-broker-7.2.3-bin.zip && cd amq-broker-7.2.3
----

[source, text]
.*2. Create a broker*
----
$ ./bin/artemis create --user admin --password admin --role admin --allow-anonymous y ./instances/broker1
----

[source, text]
.*3. Start the broker*
----
$ cd instances/broker1/
$ ./bin/artemis run
----

*4. Login to AMQ Console*

Access the http://localhost:8161/console in a broswer, login with `admin`/`admin`.

==== Deploy to OpenShift

[source, text]
.*1. Download Imagestream templete*
----
# wget https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/amq-broker-72/amq-broker-7-image-streams.yaml
----

[source, text]
.*2. Edit Imagestream, change registry.access.redhat.com to registry.example.com*
----
# vim amq-broker-7-image-streams.yaml
...
registry.example.com/amq-broker-7/amq-broker-72-openshift:1.1
registry.example.com/amq-broker-7/amq-broker-72-openshift:1.0
----

[source, text]
.*3. Create Imagestream*
----
# oc replace --force  -f amq-broker-7-image-streams.yaml -n openshift
----

[source, text]
.*4. Create AMQ Broker via link:etc/files/amq-broker-72-basic.yaml[]*
----
# oc create -f amq-broker-72-basic.yaml
# oc policy add-role-to-user view system:serviceaccount:healthcare:amq-service-account
# oc new-app --template=amq-broker-72-basic -e AMQ_PROTOCOL=openwire,amqp,stomp,mqtt,hornetq -e AMQ_USER=admin -e AMQ_PASSWORD=admin -e AMQ_ROLE=admin
----

[source, text]
.*5. Check that the broker pod is running*
----
# oc get pods
NAME                 READY     STATUS    RESTARTS   AGE
broker-amq-1-8gsv7   1/1       Running   0          1m
----

*6. Login to AMQ Console*

Access the http://amq-console-healthcare.apps.example.com/console in a broswer, login with `admin`/`admin`.

image:etc/img/amq-console.png[]

=== Inbound

[source, bash]
----
$ oc login https://master.example.com:8443 -u admin -p admin
$ oc project healthcare
$ cd inbound/
$ mvn fabric8:deploy -Popenshift
----

=== Xlate

[source, bash]
----
$ cd xlate/
$ mvn fabric8:deploy -Popenshift
----

=== Outbound

[source, bash]
----
$ cd outbound/
$ mvn fabric8:deploy -Popenshift
----

== Healthcare System Demonstration

Use the Post test tools like Post man, send a Post request with；

* URL - http://healthcare-inbound.apps.example.com/deim/api/match
* Body Content:

[source, xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<p:Person xmlns:p="http://www.app.customer.com"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.app.customer.com/PatientDemographics.xsd">
  <p:age>30</p:age>
  <p:legalname>
    <p:given>First</p:given>
    <p:family>Last</p:family>
  </p:legalname>
  <p:fathername>Dad</p:fathername>
  <p:mothername>Mom</p:mothername>
  <p:gender xsi:type="p:Code">
    <p:code>Male</p:code>
  </p:gender>
</p:Person>
----

The responses should be like

[source, xml]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ESBResponse xmlns="http://www.response.app.customer.com">
    <BusinessKey>cd448557-cbb8-4948-a034-b9808ee97580</BusinessKey>
    <Published>true</Published>
    <Comment>DONE</Comment>
</ESBResponse>
----
 
image:etc/img/healthcare-inbound-postman.png[]
